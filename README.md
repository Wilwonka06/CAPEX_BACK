# CAPEX Backend API

API Backend para CAPEX construida con Node.js, Express, MySQL y Sequelize.

## üöÄ Caracter√≠sticas

- **Base de datos:** MySQL con Sequelize ORM
- **Validaciones:** Express-validator para validaci√≥n de datos
- **Arquitectura:** MVC con separaci√≥n de responsabilidades
- **Relaciones:** Modelos relacionados con fichas t√©cnicas
- **Middleware:** Manejo global de errores y validaciones
- **CORS:** Configurado para desarrollo
- **Documentaci√≥n:** API documentada con ejemplos

## üìã Prerrequisitos

- Node.js (versi√≥n 14 o superior)
- MySQL Server
- npm o yarn

## üîß Instalaci√≥n

```bash
# Clonar el repositorio
git clone <url-del-repositorio>
cd CAPEX_BACK

# Instalar dependencias
npm install

# Configurar variables de entorno
cp .env.example .env
# Editar .env con tus credenciales de MySQL

# Ejecutar migraciones
npx sequelize-cli db:migrate

# Ejecutar seeders (opcional)
npx sequelize-cli db:seed:all

# Ejecutar en desarrollo
npm run dev

# Ejecutar en producci√≥n
npm start
```

## üåê Endpoints de la API

### Base URL

```
http://localhost:3000
```

### Endpoints disponibles
- **Productos:** `/api/productos`
- **Caracter√≠sticas:** `/api/caracteristicas`
- **Proveedores:** `/api/proveedores`
- **Categor√≠as:** `/api/categorias-productos`
- **Usuarios:** `/api/usuarios`
- **Agendamiento:** `/api/scheduling`
- **Editar Perfil:** `/api/users/:id/profile`

## üìö Documentaci√≥n de Endpoints

### Productos

| M√©todo | Endpoint | Descripci√≥n |
|--------|----------|-------------|
| GET | `/api/productos` | Obtener todos los productos |
| GET | `/api/productos/search?nombre=valor` | Buscar productos por nombre |
| GET | `/api/productos/:id` | Obtener producto por ID |
| POST | `/api/productos` | Crear nuevo producto |
| PUT | `/api/productos/:id` | Actualizar producto |
| DELETE | `/api/productos/:id` | Eliminar producto |

### Caracter√≠sticas

| M√©todo | Endpoint | Descripci√≥n |
|--------|----------|-------------|
| GET | `/api/caracteristicas` | Obtener todas las caracter√≠sticas |
| GET | `/api/caracteristicas/:id` | Obtener caracter√≠stica por ID |
| POST | `/api/caracteristicas` | Crear nueva caracter√≠stica |
| PUT | `/api/caracteristicas/:id` | Actualizar caracter√≠stica |
| DELETE | `/api/caracteristicas/:id` | Eliminar caracter√≠stica |

### Proveedores

| M√©todo | Endpoint | Descripci√≥n |
|--------|----------|-------------|
| GET | `/api/proveedores` | Obtener todos los proveedores |
| GET | `/api/proveedores/search?nombre=valor` | Buscar proveedores por nombre |
| GET | `/api/proveedores/estado/:estado` | Obtener proveedores por estado |
| GET | `/api/proveedores/:id` | Obtener proveedor por ID |
| POST | `/api/proveedores` | Crear nuevo proveedor |
| PUT | `/api/proveedores/:id` | Actualizar proveedor |
| DELETE | `/api/proveedores/:id` | Eliminar proveedor |

### Editar Perfil de Usuario

| M√©todo | Endpoint | Descripci√≥n |
|--------|----------|-------------|
| PUT | `/api/users/:id/profile` | Editar perfil de usuario |

**Campos editables:**
- `nombre` (opcional): Nombre completo del usuario
- `tipo_documento` (opcional): Tipo de documento de identidad
- `documento` (opcional): N√∫mero de documento
- `telefono` (opcional): N√∫mero de tel√©fono
- `correo` (opcional): Direcci√≥n de correo electr√≥nico
- `foto` (opcional): URL de la foto de perfil
- `direccion` (opcional): Direcci√≥n del usuario
- `contrasena` (opcional): Nueva contrase√±a

**Ejemplo de uso:**
```bash
curl -X PUT http://localhost:3000/api/users/1/profile \
  -H "Content-Type: application/json" \
  -d '{
    "nombre": "Mar√≠a Gonz√°lez",
    "telefono": "+573001234567",
    "correo": "maria.gonzalez@ejemplo.com"
  }'
```

**Documentaci√≥n completa:** Ver [EDIT_PROFILE_API.md](docs/EDIT_PROFILE_API.md)

### Categor√≠as de Productos

| M√©todo | Endpoint | Descripci√≥n |
|--------|----------|-------------|
| GET | `/api/categorias-productos` | Obtener todas las categor√≠as |
| GET | `/api/categorias-productos/:id` | Obtener categor√≠a por ID |
| POST | `/api/categorias-productos` | Crear nueva categor√≠a |
| PUT | `/api/categorias-productos/:id` | Actualizar categor√≠a |
| DELETE | `/api/categorias-productos/:id` | Eliminar categor√≠a |

### Usuarios

| M√©todo | Endpoint | Descripci√≥n |
|--------|----------|-------------|
| GET | `/api/usuarios` | Obtener todos los usuarios |
| GET | `/api/usuarios/:id` | Obtener usuario por ID |
| POST | `/api/usuarios` | Crear nuevo usuario |
| PUT | `/api/usuarios/:id` | Actualizar usuario |
| DELETE | `/api/usuarios/:id` | Eliminar usuario |

### Agendamiento

| M√©todo | Endpoint | Descripci√≥n |
|--------|----------|-------------|
| GET | `/api/scheduling` | Obtener todos los agendamientos |
| GET | `/api/scheduling/:id` | Obtener agendamiento por ID |
| POST | `/api/scheduling` | Crear nuevo agendamiento |
| PUT | `/api/scheduling/:id` | Actualizar agendamiento |
| DELETE | `/api/scheduling/:id` | Eliminar agendamiento |

## üí° Ejemplos de uso

### Crear un producto con caracter√≠sticas
```bash
curl -X POST http://localhost:3000/api/productos \
  -H "Content-Type: application/json" \
  -d '{
    "nombre": "Laptop HP Pavilion",
    "id_categoria_producto": 1,
    "costo": 800000,
    "iva": 19,
    "precio_venta": 950000,
    "stock": 10,
    "url_foto": "https://ejemplo.com/foto.jpg",
    "caracteristicas": [
      {
        "id_caracteristica": 1,
        "valor": "Intel i7"
      },
      {
        "id_caracteristica": 2,
        "valor": "16GB RAM"
      }
    ]
  }'
```

### Crear un proveedor
```bash
curl -X POST http://localhost:3000/api/proveedores \
  -H "Content-Type: application/json" \
  -d '{
    "nit": "A123456789",
    "tipo_proveedor": "J",
    "nombre": "Tecnolog√≠a Avanzada S.A.",
    "contacto": "Juan P√©rez",
    "direccion": "Calle 123 #45-67",
    "correo": "contacto@tecnologia.com",
    "telefono": "+573001234567",
    "estado": "Activo"
  }'
```

### Crear una caracter√≠stica
```bash
curl -X POST http://localhost:3000/api/caracteristicas \
  -H "Content-Type: application/json" \
  -d '{
    "nombre": "Procesador"
  }'
```

### Crear un usuario
```bash
curl -X POST http://localhost:3000/api/usuarios \
  -H "Content-Type: application/json" \
  -d '{
    "nombre": "Juan P√©rez",
    "email": "juan@ejemplo.com",
    "password": "password123",
    "rol": "admin"
  }'
```

## üóÑÔ∏è Estructura de la base de datos

### Tabla: productos
| Campo | Tipo | Descripci√≥n |
|-------|------|-------------|
| id_producto | INT | ID √∫nico (auto-increment) |
| nombre | VARCHAR(255) | Nombre del producto (√∫nico) |
| id_categoria_producto | INT | ID de la categor√≠a |
| costo | DECIMAL(15,2) | Costo del producto |
| iva | DECIMAL(5,2) | Porcentaje de IVA |
| precio_venta | DECIMAL(15,2) | Precio de venta |
| stock | INT | Cantidad en stock |
| fecha_registro | DATE | Fecha de registro |
| url_foto | VARCHAR(255) | URL de la foto |

### Tabla: caracteristicas
| Campo | Tipo | Descripci√≥n |
|-------|------|-------------|
| id_caracteristica | INT | ID √∫nico (auto-increment) |
| nombre | VARCHAR(100) | Nombre de la caracter√≠stica (√∫nico) |

### Tabla: fichas_tecnicas
| Campo | Tipo | Descripci√≥n |
|-------|------|-------------|
| id_ficha_tecnica | INT | ID √∫nico (auto-increment) |
| id_producto | INT | ID del producto |
| id_caracteristica | INT | ID de la caracter√≠stica |
| valor | VARCHAR(255) | Valor de la caracter√≠stica |

### Tabla: proveedores
| Campo | Tipo | Descripci√≥n |
|-------|------|-------------|
| id_proveedor | INT | ID √∫nico (auto-increment) |
| nit | VARCHAR(20) | NIT del proveedor (√∫nico) |
| tipo_proveedor | CHAR(1) | N (Natural) o J (Jur√≠dico) |
| nombre | VARCHAR(255) | Nombre del proveedor |
| contacto | VARCHAR(255) | Persona de contacto |
| direccion | VARCHAR(255) | Direcci√≥n |
| correo | VARCHAR(255) | Correo electr√≥nico (√∫nico) |
| telefono | VARCHAR(20) | Tel√©fono |
| estado | VARCHAR(10) | Activo o Inactivo |

### Tabla: usuarios
| Campo | Tipo | Descripci√≥n |
|-------|------|-------------|
| id_usuario | INT | ID √∫nico (auto-increment) |
| nombre | VARCHAR(255) | Nombre del usuario |
| email | VARCHAR(255) | Email (√∫nico) |
| password | VARCHAR(255) | Contrase√±a encriptada |
| rol | VARCHAR(50) | Rol del usuario |
| fecha_registro | TIMESTAMP | Fecha de registro |

### Tabla: scheduling
| Campo | Tipo | Descripci√≥n |
|-------|------|-------------|
| id_scheduling | INT | ID √∫nico (auto-increment) |
| titulo | VARCHAR(255) | T√≠tulo del agendamiento |
| descripcion | TEXT | Descripci√≥n |
| fecha_inicio | DATETIME | Fecha y hora de inicio |
| fecha_fin | DATETIME | Fecha y hora de fin |
| estado | VARCHAR(50) | Estado del agendamiento |

## üìÅ Estructura del proyecto

```
CAPEX_BACK/
‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îú‚îÄ‚îÄ config/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ database.js              # Configuraci√≥n de MySQL
‚îÇ   ‚îú‚îÄ‚îÄ controllers/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ productController.js     # Controladores de productos
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ characteristicController.js # Controladores de caracter√≠sticas
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ supplierController.js    # Controladores de proveedores
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ productCategoryController.js # Controladores de categor√≠as
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ UsersController.js       # Controladores de usuarios
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ SchedulingController.js  # Controladores de agendamiento
‚îÇ   ‚îú‚îÄ‚îÄ models/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Product.js               # Modelo de producto
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Characteristic.js        # Modelo de caracter√≠stica
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ TechnicalSheet.js        # Modelo de ficha t√©cnica
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Supplier.js              # Modelo de proveedor
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ ProductCategory.js       # Modelo de categor√≠a
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ User.js                  # Modelo de usuario
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ Scheduling.js            # Modelo de agendamiento
‚îÇ   ‚îú‚îÄ‚îÄ routes/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ ProductRoutes.js         # Rutas de productos
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ CharacteristicRoutes.js  # Rutas de caracter√≠sticas
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ SupplierRoutes.js        # Rutas de proveedores
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ ProductCategoryRoutes.js # Rutas de categor√≠as
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ UsersRoutes.js           # Rutas de usuarios
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ SchedulingRoutes.js      # Rutas de agendamiento
‚îÇ   ‚îú‚îÄ‚îÄ middlewares/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ ErrorMiddleware.js       # Middleware de errores
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ ValidationMiddleware.js  # Middleware de validaci√≥n
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ productMiddleware.js     # Validaciones de productos
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ characteristicMiddleware.js # Validaciones de caracter√≠sticas
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ supplierMiddleware.js    # Validaciones de proveedores
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ productCategoryMiddleware.js # Validaciones de categor√≠as
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ UsersMiddleware.js       # Validaciones de usuarios
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ SchedulingMiddleware.js  # Validaciones de agendamiento
‚îÇ   ‚îú‚îÄ‚îÄ services/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ productService.js        # L√≥gica de negocio de productos
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ characteristicService.js # L√≥gica de negocio de caracter√≠sticas
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ supplierService.js       # L√≥gica de negocio de proveedores
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ productCategoryService.js # L√≥gica de negocio de categor√≠as
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ UsersService.js          # L√≥gica de negocio de usuarios
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ SchedulingService.js     # L√≥gica de negocio de agendamiento
‚îÇ   ‚îú‚îÄ‚îÄ app.js                      # Configuraci√≥n de Express
‚îÇ   ‚îî‚îÄ‚îÄ server.js                   # Punto de entrada
‚îú‚îÄ‚îÄ migrations/                     # Migraciones de Sequelize
‚îú‚îÄ‚îÄ seeders/                       # Seeders de Sequelize
‚îú‚îÄ‚îÄ config/                        # Configuraci√≥n adicional
‚îú‚îÄ‚îÄ .env                           # Variables de entorno
‚îú‚îÄ‚îÄ .env.example                   # Ejemplo de variables de entorno
‚îú‚îÄ‚îÄ package.json
‚îî‚îÄ‚îÄ README.md
```

## üîß Configuraci√≥n

### Variables de entorno (.env)
```env
# Puerto del servidor
PORT=3000

# Configuraci√≥n de MySQL
DB_HOST=localhost
DB_PORT=3306
DB_NAME=capex_db
DB_USER=root
DB_PASSWORD=tu_password

# Configuraci√≥n de Sequelize
NODE_ENV=development
```

### Cambiar el puerto
Modifica la variable `PORT` en el archivo `.env`

### Configurar MySQL
Aseg√∫rate de que MySQL est√© corriendo y que las credenciales en `.env` sean correctas.

### Logs de SQL
Para ver las consultas SQL en la consola, cambia `logging: false` a `logging: console.log` en `src/config/database.js`

## üõ†Ô∏è Desarrollo

### Comandos √∫tiles
```bash
# Ejecutar en modo desarrollo con nodemon
npm run dev

# Ejecutar migraciones
npx sequelize-cli db:migrate

# Revertir migraci√≥n
npx sequelize-cli db:migrate:undo

# Ejecutar seeders
npx sequelize-cli db:seed:all

# Crear nueva migraci√≥n
npx sequelize-cli migration:generate --name nombre-migracion

# Crear nuevo seeder
npx sequelize-cli seed:generate --name nombre-seeder
```

### Agregar nuevos modelos
1. Crea el modelo en `src/models/`
2. Crea el controlador en `src/controllers/`
3. Crea las rutas en `src/routes/`
4. Registra las rutas en `src/app.js`
5. Define las relaciones en `src/app.js`
6. Crea la migraci√≥n correspondiente

### Validaciones implementadas

#### Productos
- Nombre √∫nico y solo letras (incluyendo acentos)
- Costo y precio de venta positivos
- IVA entre 0 y 40%
- Stock no negativo

#### Proveedores
- NIT √∫nico con formato letra + n√∫meros
- Tipo de proveedor: N o J
- Correo √∫nico con formato v√°lido
- Tel√©fono con formato internacional
- Estado: Activo o Inactivo

#### Caracter√≠sticas
- Nombre √∫nico y no vac√≠o

#### Usuarios
- Email √∫nico y formato v√°lido
- Contrase√±a con m√≠nimo 6 caracteres
- Rol v√°lido

## üìù Notas importantes

- **Seguridad**: En producci√≥n, implementa autenticaci√≥n y autorizaci√≥n
- **Validaci√≥n**: Usa express-validator para validaciones adicionales
- **Errores**: Maneja todos los errores apropiadamente
- **Logs**: Implementa un sistema de logging para producci√≥n
- **Relaciones**: Las fichas t√©cnicas se eliminan autom√°ticamente al eliminar un producto
- **Base de datos**: Aseg√∫rate de crear la base de datos antes de ejecutar las migraciones

## üêõ Soluci√≥n de problemas

### Error de conexi√≥n a MySQL
- Verifica que MySQL est√© corriendo
- Confirma las credenciales en `.env`
- Aseg√∫rate de que la base de datos exista

### Error de m√≥dulo no encontrado
- Ejecuta `npm install` para instalar dependencias
- Verifica que los nombres de archivos coincidan con las importaciones

### Error de migraci√≥n
- Verifica que la base de datos exista
- Confirma que las credenciales sean correctas
- Revisa los logs de error para m√°s detalles

## ü§ù Contribuir

1. Fork el proyecto
2. Crea una rama para tu feature (`git checkout -b feature/AmazingFeature`)
3. Commit tus cambios (`git commit -m 'Add some AmazingFeature'`)
4. Push a la rama (`git push origin feature/AmazingFeature`)
5. Abre un Pull Request

## üìÑ Licencia

Este proyecto est√° bajo la Licencia ISC.
